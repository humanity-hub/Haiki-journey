<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>早岐茶市場 AR Viewer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aframe/1.4.2/aframe.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ar.js/2.2.2/aframe-ar.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
            touch-action: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            background-color: #000;
        }

        .ar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 1000;
        }

        .location-marker {
            position: absolute;
            opacity: 0;
            transition: all 0.3s ease;
            pointer-events: none;
            will-change: transform, opacity;
        }

        .marker-content {
            position: relative;
            background: rgba(255, 255, 255, 0.95);
            padding: 12px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateX(-50%) translateY(10px);
            transition: transform 0.3s ease;
            backdrop-filter: blur(8px);
            max-width: 280px;
        }

        .marker-content::before {
            content: '';
            position: absolute;
            top: -8px;
            left: 50%;
            margin-left: -8px;
            border: 8px solid transparent;
            border-bottom-color: rgba(255, 255, 255, 0.95);
        }

        .marker-title {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 6px;
            color: #1a1a1a;
        }

        .marker-description {
            font-size: 13px;
            line-height: 1.4;
            color: #4a4a4a;
            margin-bottom: 6px;
        }

        .marker-distance {
            font-size: 13px;
            font-weight: 600;
            color: #007AFF;
            display: inline-block;
            background: rgba(0, 122, 255, 0.1);
            padding: 4px 8px;
            border-radius: 6px;
        }

        .status-indicator {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 24px;
            border-radius: 24px;
            font-size: 14px;
            font-weight: 500;
            z-index: 1000;
            transition: opacity 0.3s ease;
            backdrop-filter: blur(8px);
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            transition: opacity 0.5s ease;
        }

        .loading-text {
            color: white;
            font-size: 16px;
            font-weight: 500;
        }

        .error-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 59, 48, 0.9);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            font-size: 14px;
            text-align: center;
            z-index: 2000;
            display: none;
        }
    </style>
</head>
<body>
    <div id="loading" class="loading-screen">
        <div class="loading-text">読み込み中...</div>
    </div>
    <div id="error" class="error-message"></div>
    <div id="status" class="status-indicator">初期化中...</div>
    <div class="ar-overlay" id="overlay"></div>

    <a-scene vr-mode-ui="enabled: false" 
             embedded 
             arjs="sourceType: webcam; 
                   debugUIEnabled: false; 
                   detectionMode: mono_and_matrix; 
                   matrixCodeType: 3x3;
                   sourceWidth: 1280;
                   sourceHeight: 960;
                   displayWidth: 1280;
                   displayHeight: 960;">
        <a-camera gps-projected-camera rotation-reader></a-camera>
        <a-entity id="places"></a-entity>
    </a-scene>

    <script>
        // デバウンス関数
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // パフォーマンス最適化のためのRAF
        const rafLoop = {
            callbacks: new Set(),
            isRunning: false,

            add(callback) {
                this.callbacks.add(callback);
                if (!this.isRunning) {
                    this.isRunning = true;
                    this.loop();
                }
            },

            remove(callback) {
                this.callbacks.delete(callback);
                if (this.callbacks.size === 0) {
                    this.isRunning = false;
                }
            },

            loop() {
                if (!this.isRunning) return;
                this.callbacks.forEach(callback => callback());
                requestAnimationFrame(() => this.loop());
            }
        };

        AFRAME.registerComponent('place-marker', {
            schema: {
                name: { type: 'string' },
                description: { type: 'string' },
                latitude: { type: 'number' },
                longitude: { type: 'number' }
            },

            init: function() {
                this.camera = document.querySelector('[gps-projected-camera]');
                this.createMarkerElement();
                this.updatePositionBound = this.updatePosition.bind(this);
                rafLoop.add(this.updatePositionBound);

                // エラー処理
                this.errorTimeout = setTimeout(() => {
                    if (!this.hasReceivedPosition) {
                        showError('位置情報の取得に失敗しました。ページを再読み込みしてください。');
                    }
                }, 10000);
            },

            createMarkerElement: function() {
                this.marker = document.createElement('div');
                this.marker.className = 'location-marker';
                this.marker.innerHTML = `
                    <div class="marker-content">
                        <div class="marker-title">${this.data.name}</div>
                        <div class="marker-description">${this.data.description}</div>
                        <div class="marker-distance"></div>
                    </div>
                `;
                document.getElementById('overlay').appendChild(this.marker);
            },

            updatePosition: function() {
                try {
                    const distance = this.calculateDistance();
                    if (distance === null || distance > 200) {
                        this.marker.style.opacity = '0';
                        return;
                    }

                    this.hasReceivedPosition = true;
                    clearTimeout(this.errorTimeout);

                    const position = this.el.getAttribute('position');
                    if (!position) return;

                    const worldPos = new THREE.Vector3(position.x, position.y, position.z);
                    const cameraPos = new THREE.Vector3();
                    const cameraDirection = new THREE.Vector3();
                    
                    this.camera.object3D.getWorldPosition(cameraPos);
                    this.camera.object3D.getWorldDirection(cameraDirection);

                    const toTarget = worldPos.clone().sub(cameraPos).normalize();
                    const angle = THREE.MathUtils.radToDeg(cameraDirection.angleTo(toTarget));

                    if (angle <= 30) {
                        const coords = this.worldToScreen(worldPos);
                        this.marker.style.transform = `translate(${coords.x}px, ${coords.y}px)`;
                        this.marker.style.opacity = '1';
                        this.marker.querySelector('.marker-distance').textContent = 
                            `約${Math.round(distance)}m`;
                    } else {
                        this.marker.style.opacity = '0';
                    }
                } catch (error) {
                    console.error('位置の更新中にエラーが発生しました:', error);
                }
            },

            calculateDistance: function() {
                const userPos = this.camera.getAttribute('gps-position');
                if (!userPos) return null;

                return this.getHaversineDistance(
                    userPos.latitude,
                    userPos.longitude,
                    this.data.latitude,
                    this.data.longitude
                );
            },

            worldToScreen: function(worldPos) {
                const vector = worldPos.clone();
                const canvas = document.querySelector('canvas');
                vector.project(this.camera.components.camera.camera);
                
                return {
                    x: (vector.x + 1) / 2 * canvas.clientWidth,
                    y: (-vector.y + 1) / 2 * canvas.clientHeight
                };
            },

            getHaversineDistance: function(lat1, lon1, lat2, lon2) {
                const R = 6371000;
                const φ1 = lat1 * Math.PI/180;
                const φ2 = lat2 * Math.PI/180;
                const Δφ = (lat2-lat1) * Math.PI/180;
                const Δλ = (lon2-lon1) * Math.PI/180;

                const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                        Math.cos(φ1) * Math.cos(φ2) *
                        Math.sin(Δλ/2) * Math.sin(Δλ/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

                return R * c;
            },

            remove: function() {
                rafLoop.remove(this.updatePositionBound);
                if (this.marker && this.marker.parentNode) {
                    this.marker.parentNode.removeChild(this.marker);
                }
                clearTimeout(this.errorTimeout);
            }
        });

        function showError(message) {
            const errorElement = document.getElementById('error');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            setTimeout(() => {
                errorElement.style.display = 'none';
            }, 5000);
        }

        const LOCATIONS = [
            {
                name: '早岐茶市場',
                description: 'この場所は、かつて佐世保の茶取引の中心地でした。明治時代から続く歴史ある市場で、佐世保の発展に大きく貢献しました。',
                latitude: 33.13639,
                longitude: 129.79578
            },
            {
                name: '保育園',
                description: '佐世保線の重要な駅の一つで、茶市場へのアクセスポイントとして栄えました。',
                latitude: 32.92524,
                longitude: 129.97475
            }
        ];

        window.onload = () => {
            if (!navigator.geolocation || !window.DeviceOrientationEvent) {
                showError('お使いの端末では、このアプリケーションを利用できません。');
                return;
            }

            const places = document.getElementById('places');
            LOCATIONS.forEach(location => {
                const entity = document.createElement('a-entity');
                entity.setAttribute('gps-projected-entity-place', {
                    latitude: location.latitude,
                    longitude: location.longitude
                });
                entity.setAttribute('place-marker', {
                    name: location.name,
                    description: location.description,
                    latitude: location.latitude,
                    longitude: location.longitude
                });
                places.appendChild(entity);
            });

            const camera = document.querySelector('a-camera');
            const statusElement = document.getElementById('status');
            const loadingElement = document.getElementById('loading');

            const updateStatus = debounce(() => {
                statusElement.textContent = 'カメラを対象に向けてください';
                loadingElement.style.opacity = '0';
                setTimeout(() => {
                    loadingElement.style.display = 'none';
                }, 500);
            }, 1000);

            camera.addEventListener('gps-camera-update-position', updateStatus);

            // エラーハンドリング
            window.addEventListener('error', (e) => {
                console.error('エラーが発生しました:', e.error);
                showError('エラーが発生しました。ページを再読み込みしてください。');
            });
        };
    </script>
</body>
</html>