<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>早岐茶市場 AR Viewer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aframe/1.4.2/aframe.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ar.js/2.2.2/aframe-ar.js"></script>
    <style>
        .ar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 1000;
        }

        .location-marker {
            position: absolute;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .marker-content {
            position: relative;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transform: translateX(-50%);
        }

        .marker-content::before {
            content: '';
            position: absolute;
            top: -10px;
            left: 50%;
            margin-left: -10px;
            border: 10px solid transparent;
            border-bottom-color: white;
        }

        .marker-title {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .marker-description {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }

        .marker-distance {
            font-size: 12px;
            color: #007AFF;
        }

        .status-indicator {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 1000;
        }
    </style>
</head>
<body style="margin: 0; overflow: hidden;">
    <div id="status" class="status-indicator">初期化中...</div>
    <div class="ar-overlay" id="overlay"></div>

    <a-scene vr-mode-ui="enabled: false" 
             embedded 
             arjs="sourceType: webcam; 
                   debugUIEnabled: false; 
                   detectionMode: mono_and_matrix; 
                   matrixCodeType: 3x3;">
        <a-camera gps-projected-camera rotation-reader></a-camera>
        
        <a-entity id="places"></a-entity>
    </a-scene>

    <script>
        AFRAME.registerComponent('place-marker', {
            schema: {
                name: { type: 'string' },
                description: { type: 'string' },
                latitude: { type: 'number' },
                longitude: { type: 'number' }
            },

            init: function() {
                this.camera = document.querySelector('[gps-projected-camera]');
                this.createMarkerElement();
                this.updateInterval = setInterval(this.updatePosition.bind(this), 100);
            },

            createMarkerElement: function() {
                this.marker = document.createElement('div');
                this.marker.className = 'location-marker';
                this.marker.innerHTML = `
                    <div class="marker-content">
                        <div class="marker-title">${this.data.name}</div>
                        <div class="marker-description">${this.data.description}</div>
                        <div class="marker-distance"></div>
                    </div>
                `;
                document.getElementById('overlay').appendChild(this.marker);
            },

            updatePosition: function() {
                const distance = this.calculateDistance();
                if (distance > 200) {  // 200m以上離れている場合は非表示
                    this.marker.style.opacity = '0';
                    return;
                }

                const position = this.el.getAttribute('position');
                if (!position) return;

                // カメラの視野角内かどうかをチェック
                const cameraRotation = this.camera.getAttribute('rotation');
                const worldPos = new THREE.Vector3(position.x, position.y, position.z);
                const cameraPos = new THREE.Vector3();
                const cameraDirection = new THREE.Vector3();
                
                this.camera.object3D.getWorldPosition(cameraPos);
                this.camera.object3D.getWorldDirection(cameraDirection);

                const toTarget = worldPos.clone().sub(cameraPos).normalize();
                const angle = THREE.MathUtils.radToDeg(cameraDirection.angleTo(toTarget));

                // 視野角30度以内の場合のみ表示
                if (angle <= 30) {
                    const coords = this.worldToScreen(worldPos);
                    this.marker.style.left = `${coords.x}px`;
                    this.marker.style.top = `${coords.y}px`;
                    this.marker.style.opacity = '1';
                    this.marker.querySelector('.marker-distance').textContent = 
                        `約${Math.round(distance)}m`;
                } else {
                    this.marker.style.opacity = '0';
                }
            },

            calculateDistance: function() {
                const userPos = this.camera.getAttribute('gps-position');
                if (!userPos) return Infinity;

                return this.getHaversineDistance(
                    userPos.latitude,
                    userPos.longitude,
                    this.data.latitude,
                    this.data.longitude
                );
            },

            worldToScreen: function(worldPos) {
                const vector = worldPos.clone();
                const canvas = document.querySelector('canvas');
                vector.project(this.camera.components.camera.camera);
                
                return {
                    x: (vector.x + 1) / 2 * canvas.clientWidth,
                    y: (-vector.y + 1) / 2 * canvas.clientHeight
                };
            },

            getHaversineDistance: function(lat1, lon1, lat2, lon2) {
                function toRad(degrees) {
                    return degrees * Math.PI / 180;
                }

                const R = 6371000;
                const φ1 = toRad(lat1);
                const φ2 = toRad(lat2);
                const Δφ = toRad(lat2 - lat1);
                const Δλ = toRad(lon2 - lon1);

                const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                        Math.cos(φ1) * Math.cos(φ2) *
                        Math.sin(Δλ/2) * Math.sin(Δλ/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

                return R * c;
            },

            remove: function() {
                if (this.marker && this.marker.parentNode) {
                    this.marker.parentNode.removeChild(this.marker);
                }
                if (this.updateInterval) {
                    clearInterval(this.updateInterval);
                }
            }
        });

        const LOCATIONS = [
            {
                name: '早岐茶市場',
                description: 'この場所は、かつて佐世保の茶取引の中心地でした。明治時代から続く歴史ある市場で、佐世保の発展に大きく貢献しました。',
                latitude: 33.13639,
                longitude: 129.79578
            },
            {
                name: '保育園',
                description: '佐世保線の重要な駅の一つで、茶市場へのアクセスポイントとして栄えました。',
                latitude: 32.92524,
                longitude: 129.97475
            }
        ];

        window.onload = () => {
            const places = document.getElementById('places');
            
            LOCATIONS.forEach((location, index) => {
                const entity = document.createElement('a-entity');
                entity.setAttribute('gps-projected-entity-place', {
                    latitude: location.latitude,
                    longitude: location.longitude
                });
                entity.setAttribute('place-marker', {
                    name: location.name,
                    description: location.description,
                    latitude: location.latitude,
                    longitude: location.longitude
                });
                places.appendChild(entity);
            });

            // ステータス表示の更新
            const camera = document.querySelector('a-camera');
            camera.addEventListener('gps-camera-update-position', function(e) {
                document.getElementById('status').textContent = 
                    'カメラを対象に向けてください';
            });
        };
    </script>
</body>
</html>